use master
go

CREATE DATABASE Lab03 --đặt tên file database = FILENAME
	ON (NAME = Lab03_DATA, --file lưu trữ dữ liệu
    FILENAME = 'E:\DEV_SQL\LESSON3\Lab03\Lab03.mdf', --tên vật lý do hệ điều hành quản lý
    SIZE = 50,
    MAXSIZE = 200,
    FILEGROWTH = 10)
LOG ON
(NAME = Lab03_log, -- đặt tên NAME = FILENAME
    FILENAME = 'E:\DEV_SQL\LESSON3\Lab03\Lab03_log.ldf',
    SIZE = 10MB,
    MAXSIZE = unlimited, -- unilimited là ko giới hạn kích thước
    FILEGROWTH = 5MB); -- cứ đầy 5MB là file sẽ tự động tăng thêm 5MB
GO

USE [Lab03]
GO

CREATE TABLE VATTU
(
	MAVTU CHAR(4) CONSTRAINT PK_VATTU PRIMARY KEY 
	,TENVTU NVARCHAR(100) CONSTRAINT UQ_TENVTU UNIQUE
	,DVTINH VARCHAR(10) 
	,PHANTRAM REAL CHECK (PHANTRAM>=0 AND PHANTRAM<=100 )
)
GO

CREATE TABLE NHACC
(
	MANHACC CHAR(3) CONSTRAINT PK_NHACC PRIMARY KEY
	,TENNHANCC NVARCHAR (100) CONSTRAINT UQ_NHACC_TENNHACC UNIQUE
	,DIACHI NVARCHAR(250) CONSTRAINT UQ_NHACC_DIACHI UNIQUE
	,DIENTHOAI VARCHAR(20)  
)
GO

EXEC sp_rename 'dbo.NHACC.TENNHANCC', 'TENNHACC', 'COLUMN';

CREATE TABLE DONDH
(
	SODH CHAR(4) CONSTRAINT PK_SODH PRIMARY KEY
	,NGAYDH DATETIME CONSTRAINT DF_NGAYDH DEFAULT GETDATE()
	,MANHACC CHAR(3) NOT NULL
)
GO
-------------
CREATE TABLE CTDONDH
(
	SODH CHAR(4) CONSTRAINT FK_CTDONDH_DONDH_SODH FOREIGN KEY REFERENCES DONDH
	,MAVTU CHAR(4) CONSTRAINT FK_CTDONDH_VATTU_MAVTU FOREIGN KEY REFERENCES VATTU
	,SLDAT INT CONSTRAINT CK_CTDONDH_SLDAT CHECK (SLDAT>0)
	,CONSTRAINT PK_CTDONDH PRIMARY KEY (SODH,MAVTU)
)
GO

CREATE TABLE PNHAP
(
	SOPN CHAR(4) CONSTRAINT PK_PNHAP PRIMARY KEY
	,NGAYNHAP DATETIME CONSTRAINT DF_PNHAP_NGAYNHAP DEFAULT GETDATE()
	,SODH CHAR(4) CONSTRAINT FK_PNHAP_DONDH_SODH FOREIGN KEY REFERENCES DONDH
)
GO

CREATE TABLE CTPNHAP
(
	SOPN CHAR(4)
	,MAVTU CHAR(4) CONSTRAINT FK_CTPNHAP_VATTU_MAVTU FOREIGN KEY REFERENCES VATTU
	,SLNHAP INT CONSTRAINT CK_CTPNHAP_SLNHAP CHECK (SLNHAP>0)
	,CONSTRAINT PK_CTPNHAP PRIMARY KEY (SOPN,MAVTU)
)
GO

CREATE TABLE PXUAT 
(
	SOPX CHAR(4) CONSTRAINT PK_PXUAT PRIMARY KEY
	,NGAYXUAT DATETIME CONSTRAINT DF_PXUAT_NGAYXUAT DEFAULT GETDATE()
	,TENKH NVARCHAR(100) NOT NULL
)
GO

CREATE TABLE CTPXUAT
(
	SOPX CHAR(4)
	,MAVTU CHAR(4) CONSTRAINT FK_CTPXUAT_VATTU_MAVTU FOREIGN KEY REFERENCES VATTU
	,SLXUAT INT CONSTRAINT CK_STPXUAT_SLXUAT CHECK (SLXUAT>0)
	,DGXUAT MONEY CONSTRAINT CK_STPXUAT_DGXUAT CHECK (DGXUAT>0)
	,CONSTRAINT PK_CTPXUAT PRIMARY KEY (SOPX,MAVTU)
)
GO

CREATE TABLE TONKHO
(
	NAMTHANG CHAR(6)
	,MAVTU CHAR(4) CONSTRAINT FK_TONKHO_VATTU_MAVTU FOREIGN KEY REFERENCES VATTU
	,SLDAU INT CONSTRAINT CK_TONKHO_SLDAU CHECK (SLDAU>0)
	,TONGSLN INT CONSTRAINT CK_TONKHO_TONGSLN CHECK (TONGSLN>0)
	,TONGSLX INT CONSTRAINT CK_TONKHO_TONGSLX CHECK (TONGSLX>0)
	,SLCUOI AS (SLDAU + TONGSLN - TONGSLX)
	,CONSTRAINT PK_TONKHO PRIMARY KEY (NAMTHANG,MAVTU)
)
GO

INSERT NHACC(MANHACC, TENNHACC, DIACHI, DIENTHOAI) VALUES
('C01',N'Lê Minh Thành',N'54,Kim Mã, Cầu giấy, Hà Nội','87098709'),
('C02',N'Trần Quang Anh',N'54,Kim Mã, Hùng Vương, Hà Nội','87345688'),
('C03',N'Bùi Hồng Phương',N'54,Kim Mã, Hà Đông, Hà Nội','876893465'),
('C04',N'Lê Minh Đức',N'54,Kim Mã, Hai Bà Trưng, Hà Nội','87905412')
GO

SELECT * FROM NHACC
GO
----------------------------------------------------------------------------------------------------------------
INSERT VATTU(MAVTU,TENVTU,DVTINH,PHANTRAM) VALUES
('DD01',N'Đầu DVD 1 đĩa',N'Bộ',40),
('DD02',N'Đầu DVD 3 đĩa',N'Bộ',30),
('TL01',N'Tủ lạnh',N'Cái',20),
('TV25',N'Tivi sony',N'Cái',25)
GO

SELECT * FROM VATTU
GO

INSERT INTO DONDH(SODH,NGAYDH,MANHACC) VALUES
('D001',CONVERT(datetime,'12/02/2003',103),'C01'),
('D002',CONVERT(datetime,'117/03/1999',103),'C02'),
('D003',CONVERT(datetime,'20/04/1987',103),'C03'),
('D004',CONVERT(datetime,'23/06/2008',103),'C04')
GO




SELECT * FROM DONDH
GO

INSERT PNHAP(SOPN,NGAYNHAP,SODH) VALUES
('N001','01/11/2012','D001'),
('N002','04/17/2012','D002'),
('N003','09/15/2012','D003'),
('N004','09/15/2012','D004')
GO

SELECT * FROM PNHAP
GO

INSERT CTDONDH(SODH,MAVTU,SLDAT) VALUES
('D001','DD01',10),
('D002','DD02',5),
('D003','TL01',20),
('D004','TV25',15)
GO


SELECT * FROM CTDONDH
GO


/*
ALTER TABLE CTPNHAP 
	ADD DGNHAP MONEY CONSTRAINT CK_CTPNHAP_DGNHAP CHECK (DGNHAP>0)
GO	
*/


INSERT CTPNHAP(SOPN,MAVTU,SLNHAP,DGNHAP) VALUES
('N001','DD01',8,'2,500,000'),
('N002','DD02',18,'2,400,000'),
('N003','TL01',28,'2,300,000'),
('N004','TV25',6,'2,300,000')
GO

SELECT * FROM CTPNHAP
GO

INSERT PXUAT(SOPX,NGAYXUAT,TENKH) VALUES
('X001','01/11/2012',N'Nguyễn Ngọc Phương Nhi'),
('X002','01/09/2002',N'Nguyễn Ngọc Phương Nam'),
('X003','01/05/1982',N'Nguyễn Ngọc Phương'),
('X004','01/06/1992',N'Nguyễn Ngọc Nhi')
GO

SELECT * FROM PXUAT
GO

INSERT INTO CTPXUAT(SOPX,MAVTU,SLXUAT,DGXUAT) VALUES
('X001','DD01',2,'2,000,000'),
('X002','DD02',4,'4,000,000'),
('X003','TL01',3,'5,000,000'),
('X004','TV25',5,'1,000,000')
GO



SELECT * FROM CTPXUAT
GO
-------
INSERT TONKHO(NAMTHANG,MAVTU,SLDAU,TONGSLN,TONGSLX) VALUES
('201201','DD01',1,10,6),
('201206','DD02',1,30,10),
('201204','TL01',1,15,7),
('201202','TV25',8,1,1)
GO

SELECT * FROM TONKHO
GO
